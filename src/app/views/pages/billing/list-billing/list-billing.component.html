<kt-portlet>

	<kt-portlet-header [title]="'IPL Billing List'" [class]="'kt-portlet__head--lg'" [viewLoading$]="dataSource.loading$">
		<ng-container ktPortletTools>
			<button mat-raised-button class="mr-2" (click)="refresh()">Refresh
				<mat-icon class="ic-refresh">
					refresh
				</mat-icon>
			</button>
		</ng-container>
		<ng-container ktPortletTools>
			<button *ngIf="this.isButtonVisible" [routerLink]="['add']" mat-raised-button color="primary"
				[hidden]="role === 'admin-tro' || role === 'spv-tro' || role === 'manager' || role === 'cashier' || role === 'collection' ">Add
				New</button>
		</ng-container>
		<ng-container ktPortletTools>
			<button mat-raised-button color="primary" class="ml-2" (click)="openLarge(modalautobilling)"
				[hidden]="role === 'admin-tro' || role === 'spv-tro' || role === 'manager'  || role === 'cashier' || role === 'collection' ">Generate</button>
		</ng-container>
		<ng-container ktPortletTools>
			<button (click)="export()" mat-raised-button color="primary" class="ml-2"
				[hidden]="role === 'admin-tro' || role === 'spv-tro'  || role === 'cashier'">Export</button>
		</ng-container>
		<!-- Button Tester PopUp process generate (Start) -->
		<!-- <ng-container ktPortletTools>
			<button (click)="processGenerate(modalprocessgenerate)" mat-raised-button color="primary" class="ml-2">Tester
				Process</button>
		</ng-container> -->
		<!-- Button Tester PopUp process generate (End) -->
	</kt-portlet-header>
	<div class="modalautobilling">
		<div>
			<ng-template #modalautobilling let-c="close" let-d="dismiss">
				<div class="modal-header">
					<h4 class="modal-title">Generate</h4>
					<button type="button" class="close" aria-label="Close" (click)="d('Cross click')">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<form class="kt-form kt-form--label-right dropzone">
						<div class="kt-portlet__body">
							<div class="form-group row">
								<div class="col-lg-6 col-md-12 col-sm-12 mx-auto">
									<mat-form-field appearance="fill">
										<mat-label>Pilih Periode Billing</mat-label>
										<input matInput [matDatepicker]="picker" (dateChange)="changePeriode($event)"
											(click)="picker.open()" autocomplete="off">
										<mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
										<mat-datepicker #picker></mat-datepicker>
									</mat-form-field>
								</div>
							</div>
						</div>
						<div class="kt-portlet__foot">
							<div class="kt-form__actions">
								<div class="row">Note : Proses Generate Untuk Consumtion (Billing Month - 1).
								</div>
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" (click)="c('Close click')">Close</button>
					<button type="button" class="btn btn-primary"
						(click)="processGenerate(modalprocessgenerate); auto(c); c('Close click')">Generate</button>
				</div>
			</ng-template>
		</div>
	</div>

	<!-- ====================== Pop Up Process Generate ====================== -->
	<div class="modalprocessgenerate">
		<div>
			<ng-template #modalprocessgenerate let-c="close" let-d="dismiss">
				<div class="modal-body process-generate">
					<!-- ========================== Condition Process ========================== -->
					<div class="kt-portlet__body">
						<div class="processing">
							<div [hidden]="isGenerateBilling !== ''">
								<div class="d-flex align-items-center flex-column">
									<h3 class=" mt-5">PROCESS GENERATE BILLING,
										{{dateGenerateBilling?dateGenerateBilling : "..."}}</h3>
									<div class="d-flex p-2 mb-5 warn-alert">
										<mat-icon>warning</mat-icon>
										<p class="m-0 p-0">don't exit the page or open a new page in the browser tab!!
										</p>
									</div>
									<mat-spinner></mat-spinner>
									<p class="mt-2 load-process">Please wait, until the process is
										complete...</p>
								</div>
							</div>
						</div>
					</div>
					<!-- ========================== Condition Success ========================== -->
					<div class="kt-portlet__body">
						<div class="success-generate">
							<div [hidden]="isGenerateBilling !== 'success'">
								<div class="d-flex   align-items-center flex-column">
									<h3 class="mb-3 mt-5 mb-5">Success! Generate Billing,
										{{dateGenerateBilling?dateGenerateBilling :
										"..."}}</h3>
									<img src="../../../../../assets/media/pos/checked.png" alt="checked" width="100">
									<div class="success-alert p-2 mt-4 d-flex mb-3">
										<mat-icon>info</mat-icon>
										<p class="m-0 p-0">the generate process is successful, please check the billing
											that has been
											entered into the list.</p>
									</div>
									<button (click)="closePopUp()" mat-raised-button color="primary" class="ml-2">Back
										to billing</button>
								</div>
							</div>
						</div>
					</div>
					<!-- ========================== Condition Failed ========================== -->
					<div class="kt-portlet__body">
						<div class="failed-generate">
							<div [hidden]="isGenerateBilling !== 'failed'">
								<div class="d-flex   align-items-center flex-column">
									<h3 class="mb-3 mt-5 mb-5">
										<mat-icon>warning</mat-icon> Failed! Generate Billing,
										{{dateGenerateBilling?dateGenerateBilling :
										"..."}}
									</h3>
									<kt-alert type="warn">
										{{msgErrorGenerate ? msgErrorGenerate :
										'generate billing failed, recheck power and water consumption data.'}}
									</kt-alert>
									<p>Note : generate billing failed, recheck power and water consumption data.</p>
									<button (click)="closePopUp()" mat-raised-button color="primary" class="ml-2">Back
										to billing</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</ng-template>
		</div>
	</div>

	<kt-portlet-body>
		<!-- start::FILTERS & GROUP ACTIONS -->
		<div class="kt-form">

			<!-- start::FILTERS -->
			<div class="kt-form__filtration">
				<div class="row">
					<div class="col-md-6 kt-margin-bottom-10-mobile">
						<div class="row align-items-center">
							<div class="col-md-4 kt-margin-bottom-10-mobile">
								<mat-form-field class="mat-form-field-fluid">
									<input matInput placeholder="Search user" #searchInput placeholder="Search"
										class="mat-form-field mat-form-field-fluid">
									<mat-hint align="start">
										<strong>Search</strong> in Unit No. and Bill Number
									</mat-hint>
								</mat-form-field>
							</div>

							<div class="col-md-5 kt-margin-bottom-10-mobile">
								<mat-form-field class="mat-form-field-fluid">
									<mat-select placeholder="Filter By Status" [formControl]="date.filter.control">
										<mat-option *ngFor="let list of filterByStatus" [value]="clearAllFilter"
											(click)="valueFilterStatus(list.value)">{{ list.payment }}</mat-option>
									</mat-select>
								</mat-form-field>
							</div>
						</div>

						<div class="row mt-4 align-items-center">
							<div class="col-md-4 col-sm-12 kt-margin-bottom-10-mobile">
								<mat-form-field class="mat-form-field-fluid" appearance="fill">
									<mat-label>Month and Year</mat-label>
									<input matInput [matDatepicker]="dp" [formControl]="dateMonth">
									<mat-hint>MM/YYYY</mat-hint>
									<mat-datepicker-toggle matSuffix [for]="dp"></mat-datepicker-toggle>
									<mat-datepicker #dp startView="multi-year" (monthSelected)="setMonthAndYear($event, dp)"
										panelClass="example-month-picker">
									</mat-datepicker>
								</mat-form-field>
							</div>

							<div class="col-md-3 col-sm-6 kt-margin-bottom-10-mobile">
								<mat-label>Total Count</mat-label>
								<h3>{{dataSource.paginatorTotal$ | async}}</h3>
								<!-- <h3>111</h3> -->
							</div>

							<div class="col-md-5 col-sm-6 kt-margin-bottom-10-mobile">
								<mat-label>Total Amount</mat-label>
								<h4>{{totalAmount()}}</h4>
								<!-- <h4>Rp. 1111111123000</h4> -->
							</div>
						</div>

						<div class="row align-items-center">
							<div class="row">
								<div class="col-md-4">
									<div *ngIf="checkClear" class="col-md-12 mt-4">
										<button mat-raised-button color="warn" (click)="clearAllFilter()">
											Clear All Filter
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="col-md-6 kt-margin-bottom-10-mobile">
						<div class="mark__title">
							<span>Mark color info</span>
						</div>

						<div class="row">

							<div class="mark__list col-md-8">
								<div class="mark__item">
									<span class="mark__item-color mark__item-color--success"></span>
									<span class="mark__item-description">Paid</span>
								</div>

								<div class="mark__item">
									<span class="mark__item-color"></span>
									<span class="mark__item-description">Unpaid, not on due date</span>
								</div>

								<div class="mark__item">
									<span class="mark__item-color mark__item-color--warning"></span>
									<span class="mark__item-description">Unpaid, due date passed but less than 7
										days</span>
								</div>

								<div class="mark__item">
									<span class="mark__item-color mark__item-color--danger"></span>
									<span class="mark__item-description">Unpaid, due date passed more than 7 days</span>
								</div>

							</div>
							<div class="mark__list col-md-4">
								<div class="mark__item">
									<span class="mark__item-color mark__item-color--full-payment"></span>
									<span class="mark__item-description">Full payment</span>
								</div>
								<div class="mark__item">
									<span class="mark__item-color mark__item-color--parsial-lebih"></span>
									<span class="mark__item-description">Bayar lebih</span>
								</div>

								<div class="mark__item">
									<span class="mark__item-color mark__item-color--parsial-kurang"></span>
									<span class="mark__item-description">Bayar kurang</span>
								</div>

								<div class="mark__item">
									<span class="mark__item-color mark__item-color--outstanding"></span>
									<span class="mark__item-description">Outstanding</span>
								</div>

							</div>
						</div>
					</div>

				</div>
			</div>
			<!-- end::FILTERS -->


		</div>
		<!-- end:: NEW FILTERS & GROUP ACTIONS -->

		<!-- MATERIAL TABLE | Binded to datasources -->
		<!-- See off.documentations 'https://material.angular.io/components/table/overview' -->
		<!-- Selected Post Start-->
		<div class="row align-items-center collapse kt-form__group-actions kt-margin-top-20 kt-margin-bottom-20"
			[ngClass]="{'show' : selection.selected.length > 0}">
			<!-- We show 'Group Actions' div if smth are selected -->
			<div class="col-xl-12">
				<div class="kt-form__group kt-form__group--inline">
					<div class="kt-form__label kt-form__label-no-wrap">
						<label class="kt--font-bold kt-font-danger-">
							<span translate="ECOMMERCE.COMMON.SELECTED_RECORDS_COUNT"></span> {{
							selection.selected.length }}
						</label>
						<!-- selectedCountsTitle => function from codeBehind (users-list.component.ts file) -->
						<!-- selectedCountsTitle => just returns title of selected items count -->
						<!-- for example: Selected records count: 4 -->
					</div>
					<div class="kt-form__control kt-form__group--inline">
						<button (click)="selectedBilling()" mat-raised-button matTooltip="Post Mobile Selected" color="primary"
							class="mat-button-mt-4 mx-2">
							<mat-icon>stay_current_portrait</mat-icon>
							Post To Mobile
						</button>
					</div>
				</div>
			</div>
		</div>
		<!-- Selected Post End -->
		<div class="mat-table__wrapper">
			<mat-table class="lmat-elevation-z8" #table [dataSource]="dataSource" matSort #sort1="matSort" matSortActive="id"
				matSortDirection="desc" matSortDisableClear>
				<!-- Select Billing To Post START -->
				<ng-container matColumnDef="select">
					<mat-header-cell *matHeaderCellDef class="mat-column-checkbox">
						<mat-checkbox (change)="$event ? masterToggle() : null" [checked]="selection.hasValue() && isAllSelected()"
							[indeterminate]="selection.hasValue() && !isAllSelected()">
						</mat-checkbox>
					</mat-header-cell>
					<mat-cell *matCellDef="let billing" class="mat-column-checkbox">
						<mat-checkbox *ngIf="billing.isPost == true" [checked]="true" [disabled]="billing.isPost == true">
						</mat-checkbox>
						<mat-checkbox *ngIf="billing.isPost == false" (click)="$event.stopPropagation()"
							(change)="$event ? selection.toggle(billing) : null" [checked]="selection.isSelected(billing)"
							[disabled]="billing.isPost == true">
						</mat-checkbox>
					</mat-cell>
				</ng-container>
				<!-- <ng-container matColumnDef="prnt">
					<mat-header-cell *matHeaderCellDef>Print</mat-header-cell>
					<mat-cell *matCellDef="let billing">
						<button (click)="cekBeforePrint(billing._id)" mat-icon-button color="primary"
							matTooltip="Print billing" [disabled]="loadingbilling == true">
							<mat-icon [matBadge]="printedNumber(billing,'number')" matBadgeSize="small"
								[matBadgeHidden]="printedNumber(billing,'display')" matBadgeColor="primary">print</mat-icon>
						</button>
					</mat-cell>
				</ng-container> -->
				<ng-container matColumnDef="print_invoice">
					<mat-header-cell *matHeaderCellDef>Invoice</mat-header-cell>
					<mat-cell *matCellDef="let billing">
						<button (click)="cekBeforePrint(billing._id,'invoice')" mat-icon-button color="warn"
							matTooltip="Print Invoice" [disabled]="loadingbilling == true">
							<!-- <mat-icon>print</mat-icon> -->
							<mat-icon [matBadge]="printedNumber(billing,'number','invoice')" matBadgeSize="small"
								[matBadgeHidden]="printedNumber(billing,'display','invoice')" matBadgeColor="primary">print</mat-icon>
						</button>
					</mat-cell>
				</ng-container>
				<ng-container matColumnDef="print_receipt">
					<mat-header-cell *matHeaderCellDef>Receipt</mat-header-cell>
					<mat-cell *matCellDef="let billing">
						<button *ngIf="billing?.paymentStatus" (click)="cekBeforePrint(billing._id,'receipt')" mat-icon-button
							color="primary" matTooltip="Print Receipt" [disabled]="loadingbilling == true">
							<!-- <mat-icon>print</mat-icon> -->
							<mat-icon [matBadge]="printedNumber(billing,'number','receipt')" matBadgeSize="small"
								[matBadgeHidden]="printedNumber(billing,'display','receipt')" matBadgeColor="primary">print</mat-icon>
						</button>
					</mat-cell>
				</ng-container>

				<ng-container matColumnDef="billing_number">
					<mat-header-cell *matHeaderCellDef>Bill No.</mat-header-cell>
					<mat-cell *matCellDef="let billing">
						<span>{{ billing?.billing_number | uppercase }}
						</span>
					</mat-cell>
				</ng-container>

				<!-- <ng-container matColumnDef="billedTo">
					<mat-header-cell *matHeaderCellDef style="margin-left: 20px;">Bill to</mat-header-cell>
					<mat-cell *matCellDef="let billing">
						<span style="margin-left: 20px;">{{ billing?.billed_to | titlecase}}</span>
					</mat-cell>
				</ng-container> -->

				<ng-container matColumnDef="Unit">
					<mat-header-cell *matHeaderCellDef>Unit No.</mat-header-cell>
					<mat-cell *matCellDef="let billing" style="margin-left: 20px;">{{billing?.unit2 | uppercase }}
					</mat-cell>
				</ng-container>

				<ng-container matColumnDef="billing_date">
					<mat-header-cell *matHeaderCellDef mat-sort-header>Bill Date</mat-header-cell>
					<mat-cell *matCellDef="let billing">
						<span>{{ billing?.billing_date | date:"d/MM/y"}}</span>
					</mat-cell>
				</ng-container>

				<ng-container matColumnDef="due_date">
					<mat-header-cell *matHeaderCellDef mat-sort-header>Due Date</mat-header-cell>
					<mat-cell *matCellDef="let billing">{{ billing?.due_date | date:"dd/MM/y" }}</mat-cell>
				</ng-container>

				<ng-container matColumnDef="totalBilling">
					<mat-header-cell *matHeaderCellDef>Nominal (Rp.)</mat-header-cell>
					<mat-cell *matCellDef="let billing">
						<span>
							<span [ngClass]="billing.isPinalty ? 'clr-red ' : ''">{{ billing?.totalBilling |
								currency: "IDR": ""}}</span>
						</span>
					</mat-cell>
				</ng-container>

				<ng-container matColumnDef="paymentStatus">
					<mat-header-cell *matHeaderCellDef mat-sort-header>Payment Progress</mat-header-cell>
					<mat-cell *matCellDef="let billing">
						<span [ngClass]="_getPaymentClass(billing.paymentStatus)">{{ billing?.paymentStatus ? "Paid" :
							"UnPaid"}}</span>
					</mat-cell>
				</ng-container>

				<ng-container matColumnDef="isPaid">
					<mat-header-cell *matHeaderCellDef mat-sort-header>Status</mat-header-cell>
					<mat-cell *matCellDef="let billing">
						<span [ngClass]="_getStatusClass(billing.isPaid, billing.due_date)">
							{{ billing?.isPaid ? "Closed" : "On Ver." }}
						</span>
					</mat-cell>
				</ng-container>
				<ng-container matColumnDef="isPost">
					<mat-header-cell *matHeaderCellDef mat-sort-header>Mobile</mat-header-cell>
					<mat-cell *matCellDef="let billing">
						<span [ngClass]="_getStatusIsPost(billing.isPost)">
							{{ billing?.isPost ? "Posted" : "Unpost" }}
						</span>
					</mat-cell>
				</ng-container>

				<ng-container matColumnDef="payCond">
					<mat-header-cell *matHeaderCellDef>Payment Status</mat-header-cell>
					<mat-cell *matCellDef="let billing">
						<!-- <span
							[ngClass]="_getStatusPayCond((billing.payCond ? billing.payCond : billing.isPaid ? 'paid' : 'outstanding'))">
							{{billing.payCond ? billing.payCond : billing.isPaid ? "Paid" : 'Outstanding'}}
						</span> -->
						<span
							[ngClass]="_getStatusPayCond((billing.payCond ? billing.payCond : billing.isPaid ? 'full-payment' : 'outstanding'), billing)">
							{{billing.isPaid && billing.paymentStatus && billing.payCond ===
							'outstanding' ? 'full-payment' : billing.isPaid && billing.paymentStatus && billing.payCond
							=== undefined
							? 'full-payment' :
							billing.payCond == "full-payment" &&
							billing.paymentSelection == "bayar-lebih" ?
							"bayar-lebih" : billing.payCond ?
							billing.payCond : billing.isPaid ? "full payment" : 'Outstanding'}}
						</span>
					</mat-cell>
				</ng-container>

				<ng-container matColumnDef="actions">
					<mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
					<mat-cell *matCellDef="let billing">
						<button (click)="editBilling(billing._id)" mat-icon-button color="primary" matTooltip="Update"
							[hidden]="role === 'admin-tro' || role === 'spv-tro' || role === 'collection' "
							[disabled]="billing.isPaid">
							<mat-icon>exit_to_app</mat-icon>
						</button>&nbsp;
						<button (click)="viewBilling(billing._id)" mat-icon-button color="primary" matTooltip="View">
							<mat-icon>visibility</mat-icon>
						</button>&nbsp;
						<button mat-icon-button color="warn" matTooltip="Delete" type="button" (click)="deleteBilling(billing)"
							[hidden]="role === 'admin-tro' || role === 'spv-tro' || role === 'cashier' || role === 'collection' "
							[disabled]="false">
							<mat-icon>delete</mat-icon>
						</button>
					</mat-cell>
				</ng-container>

				<mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>

				<mat-row *matRowDef="let row; columns: displayedColumns"></mat-row>
			</mat-table>
			<div class="mat-table__message" *ngIf="!(dataSource.loading$ | async) && billingResult.length <= 0">No
				records
				found</div><!-- Message for empty data  -->
			<div class="mat-table__message" *ngIf="dataSource.isPreloadTextViewed$ | async">Please wait....</div>
		</div>

		<!-- start: BOTTOM -->
		<div class="mat-table__bottom">
			<!-- MATERIAL SPINNER | Url: 'https://material.angular.io/components/progress-spinner/overview' -->
			<mat-spinner [diameter]="20" *ngIf="dataSource.loading$ | async"></mat-spinner>
			<!-- MATERIAL PAGINATOR | Binded to dasources -->
			<!-- See off.documentations 'https://material.angular.io/components/paginator/overview' -->
			<mat-paginator [pageSize]="10" [pageSizeOptions]="[10, 20, 50,100,500,1000,2000]"
				[length]="dataSource.paginatorTotal$ | async" [showFirstLastButtons]="true"></mat-paginator>
		</div>
		<!-- end: BOTTOM -->
	</kt-portlet-body>
</kt-portlet>